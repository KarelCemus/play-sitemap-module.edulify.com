<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Sitemap Generator Module by edulify</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Sitemap Generator Module</h1>
      <h2 class="project-tagline">Play module to create automatic sitemaps</h2>
      <a href="https://github.com/edulify/play-sitemap-module.edulify.com" class="btn">View on GitHub</a>
      <a href="https://github.com/edulify/play-sitemap-module.edulify.com/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/edulify/play-sitemap-module.edulify.com/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="sitemap-generator-module" class="anchor" href="#sitemap-generator-module" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sitemap Generator Module</h1>

<p>This is a module that generates <a href="http://www.sitemaps.org/">sitemaps</a> for <a href="http://www.playframework.org/">Play Framework</a> 2.3.x and 2.4.x. It is build using <a href="https://github.com/dfabulich/sitemapgen4j/">SitemapGen4j</a> to generate the sitemap files.</p>

<p><a href="https://travis-ci.org/edulify/play-sitemap-module.edulify.com"><img src="https://travis-ci.org/edulify/play-sitemap-module.edulify.com.svg" alt="Build Status"></a></p>

<h2>
<a id="compatibility-matrix" class="anchor" href="#compatibility-matrix" aria-hidden="true"><span class="octicon octicon-link"></span></a>Compatibility matrix</h2>

<table>
<thead>
<tr>
<th align="left">Playframework version</th>
<th align="left">Module version</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">2.4.6</td>
<td align="left">2.0.0</td>
</tr>
<tr>
<td align="left">2.4.x</td>
<td align="left">2.0.0-M1</td>
</tr>
<tr>
<td align="left">2.3.x</td>
<td align="left">1.1.8</td>
</tr>
<tr>
<td align="left">2.3.x</td>
<td align="left">1.1.7</td>
</tr>
<tr>
<td align="left">2.3.x</td>
<td align="left">1.1.6</td>
</tr>
<tr>
<td align="left">2.2.x</td>
<td align="left">1.1.5</td>
</tr>
<tr>
<td align="left">2.1.x</td>
<td align="left">1.1.3</td>
</tr>
</tbody>
</table>

<h2>
<a id="about-sitemaps-and-seo" class="anchor" href="#about-sitemaps-and-seo" aria-hidden="true"><span class="octicon octicon-link"></span></a>About Sitemaps and SEO</h2>

<p>You can find more about sitemap and why it matters for Search Engine Optimization at <a href="http://techtalk.edulify.com/2013/04/09/seo-and-sitemap">Tech Talk blog</a>.</p>

<h2>
<a id="configuring" class="anchor" href="#configuring" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring</h2>

<p>The first step is include the sitemap module in your dependencies list, in <code>build.sbt</code> or <code>Build.scala</code> file:</p>

<h4>
<a id="buildsbt" class="anchor" href="#buildsbt" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>build.sbt</code>
</h4>

<div class="highlight highlight-source-scala"><pre>resolvers <span class="pl-k">++</span><span class="pl-k">=</span> <span class="pl-en">Seq</span>(
  <span class="pl-en">Resolver</span>.url(<span class="pl-s"><span class="pl-pds">"</span>Edulify Repository<span class="pl-pds">"</span></span>, url(<span class="pl-s"><span class="pl-pds">"</span>https://edulify.github.io/modules/releases/<span class="pl-pds">"</span></span>))(<span class="pl-en">Resolver</span>.ivyStylePatterns)
)

...

libraryDependencies <span class="pl-k">++</span><span class="pl-k">=</span> <span class="pl-en">Seq</span>(
  <span class="pl-s"><span class="pl-pds">"</span>com.edulify<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>sitemap-module<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>2.0.0<span class="pl-pds">"</span></span>
)</pre></div>

<h4>
<a id="buildscala" class="anchor" href="#buildscala" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>Build.scala</code>
</h4>

<div class="highlight highlight-source-scala"><pre><span class="pl-k">import</span> <span class="pl-v">sbt.</span><span class="pl-v">_</span>
<span class="pl-k">import</span> <span class="pl-v">Keys.</span><span class="pl-v">_</span>
<span class="pl-k">import</span> <span class="pl-v">play.Project.</span><span class="pl-v">_</span>

<span class="pl-k">object</span> <span class="pl-en">ApplicationBuild</span> <span class="pl-k">extends</span> <span class="pl-e">Build</span> {

  <span class="pl-k">val</span> <span class="pl-en">appName</span>         <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>sitemap-sample<span class="pl-pds">"</span></span>
  <span class="pl-k">val</span> <span class="pl-en">appVersion</span>      <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>1.0-SNAPSHOT<span class="pl-pds">"</span></span>

  <span class="pl-k">val</span> <span class="pl-en">appDependencies</span> <span class="pl-k">=</span> <span class="pl-en">Seq</span>(
    <span class="pl-c">// Add your project dependencies here,</span>
    javaCore,
    javaJdbc,
    <span class="pl-s"><span class="pl-pds">"</span>com.edulify<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>sitemap-module<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>2.0.0<span class="pl-pds">"</span></span>
  )

  <span class="pl-k">val</span> <span class="pl-en">main</span> <span class="pl-k">=</span> play.<span class="pl-en">Project</span>(appName, appVersion, appDependencies).settings(
    <span class="pl-c">// Add your own project settings here</span>
    resolvers <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-en">Resolver</span>.url(<span class="pl-s"><span class="pl-pds">"</span>Edulify Repository<span class="pl-pds">"</span></span>, url(<span class="pl-s"><span class="pl-pds">"</span>https://edulify.github.io/modules/releases/<span class="pl-pds">"</span></span>))(<span class="pl-en">Resolver</span>.ivyStylePatterns)
  )

}
</pre></div>

<p>Don't forget to add the resolver to your list of resolvers.</p>

<p>Ok, now you need to configure the module in your <code>application.conf</code> (the configuration syntax is defined by <a href="https://github.com/typesafehub/config">Typesafe Config</a>):</p>

<pre><code>play.modules.enabled += "com.edulify.modules.sitemap.SitemapModule"

...

sitemap {
  baseDir   = "/path/where/sitemaps/file/will/be/saved"
  baseUrl   = "http://localhost:9000"
  providers = "sitemap.providers.ArticlesUrlProvider"
}
</code></pre>

<ul>
<li>
<code>baseUrl</code>: the base URL for links provided in your sitemap.</li>
<li>
<code>baseDir</code>: as it says, the complete path to directory where you want your sitemap xml files be saved. If you don't provide this value, the sitemap files will be saved under your <code>public</code> directory.</li>
<li>
<code>providers</code>: a comma separated list of <em>provider classes</em> that will generate URLs for your sitemap (see below).</li>
</ul>

<p>You must also configure an execution context that will execute the sitemap job:</p>

<pre><code>sitemap.dispatcher.name = "akka.actor.sitemap-generator"
akka {

  // see play's thread pools configuration for more details

  actor {

    sitemap-generator = {
      fork-join-executor {
        parallelism-factor = 2.0
        parallelism-max = 24
      }
    }

  }
}
</code></pre>

<ul>
<li>
<code>dispatcher.name</code>: name of the dispatcher used in the Akka system.</li>
</ul>

<p>A complete example of the configuration is presented bellow:</p>

<pre><code>play.modules.enabled += "com.edulify.modules.sitemap.SitemapModule"

sitemap {
  dispatcher {
    name    = "akka.actor.Sitemapper"
  }
  baseUrl   = "http://localhost:9000"
  providers = "sitemap.providers.ArticlesUrlProvider"
}

akka {
  // see play's thread pools configuration for more details
  actor {
    Sitemapper = {
      fork-join-executor {
        parallelism-factor = 2.0
        parallelism-max = 24
      }
    }
  }
}
</code></pre>

<h2>
<a id="using" class="anchor" href="#using" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using</h2>

<p>With everything configured, now its time to add some URLs to your sitemap(s). The simplest way is add the <code>@SitemapItem</code> annotation to your controllers methods which doesn't expect arguments:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">package</span> <span class="pl-smi">controllers</span>;

<span class="pl-k">import</span> <span class="pl-smi">com.edulify.modules.sitemap.SitemapItem</span>;
<span class="pl-k">import</span> <span class="pl-smi">com.redfin.sitemapgenerator.ChangeFreq</span>;

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Articles</span> <span class="pl-k">extends</span> <span class="pl-e">Controller</span> {

  <span class="pl-k">@SitemapItem</span>
  <span class="pl-k">public</span> <span class="pl-smi">Result</span> <span class="pl-en">listArticles</span>() { <span class="pl-c1">...</span> }

  <span class="pl-k">@SitemapItem</span>(<span class="pl-c1">changefreq</span> <span class="pl-k">=</span> <span class="pl-smi">ChangeFreq</span><span class="pl-c1"><span class="pl-k">.</span>MONTHLY</span>, <span class="pl-c1">priority</span> <span class="pl-k">=</span> <span class="pl-c1">0.8</span>)
  <span class="pl-k">public</span> <span class="pl-smi">Result</span> <span class="pl-en">specialArticles</span>() { <span class="pl-c1">...</span> }
}</pre></div>

<p>This will add the route for such method in the sitemap. The default values for the <em>changefreq</em> and <em>priority</em> attributes are <strong>daily</strong> and <strong>0.5</strong> respectively.</p>

<p>For methods that needs arguments, you must implement a URL provider that will add the generated URL to sitemap. Here is an example:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">package</span> <span class="pl-smi">sitemap.providers</span>;

<span class="pl-k">import</span> <span class="pl-smi">java.net.MalformedURLException</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.util.List</span>;

<span class="pl-k">import</span> <span class="pl-smi">com.edulify.modules.sitemap.SitemapConfig</span>;
<span class="pl-k">import</span> <span class="pl-smi">models.Article</span>;

<span class="pl-k">import</span> <span class="pl-smi">controllers.routes</span>;

<span class="pl-k">import</span> <span class="pl-smi">com.edulify.modules.sitemap.UrlProvider</span>;

<span class="pl-k">import</span> <span class="pl-smi">com.redfin.sitemapgenerator.ChangeFreq</span>;
<span class="pl-k">import</span> <span class="pl-smi">com.redfin.sitemapgenerator.WebSitemapUrl</span>;
<span class="pl-k">import</span> <span class="pl-smi">com.redfin.sitemapgenerator.WebSitemapGenerator</span>;

<span class="pl-k">import</span> <span class="pl-smi">javax.inject.Inject</span>;

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ArticlesUrlProvider</span> <span class="pl-k">implements</span> <span class="pl-e">UrlProvider</span> {

  <span class="pl-k">private</span> <span class="pl-smi">SitemapConfig</span> config;

  <span class="pl-k">@Inject</span>
  <span class="pl-k">public</span> <span class="pl-en">ArticlesUrlProvider</span>(<span class="pl-smi">SitemapConfig</span> <span class="pl-v">config</span>) {
      <span class="pl-v">this</span><span class="pl-k">.</span>config <span class="pl-k">=</span> config;
  }

  <span class="pl-k">@Override</span>
  <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">addUrlsTo</span>(<span class="pl-smi">WebSitemapGenerator</span> <span class="pl-v">generator</span>) {
    <span class="pl-smi">String</span> baseUrl <span class="pl-k">=</span> config<span class="pl-k">.</span>getBaseUrl();

    <span class="pl-k">List&lt;<span class="pl-smi">Article</span>&gt;</span> articles <span class="pl-k">=</span> <span class="pl-smi">Article</span><span class="pl-k">.</span>find<span class="pl-k">.</span>all();
    <span class="pl-k">for</span>(<span class="pl-smi">Article</span> article <span class="pl-k">:</span> articles) {
      <span class="pl-smi">String</span> articleUrl <span class="pl-k">=</span> <span class="pl-smi">routes<span class="pl-k">.</span>Application</span><span class="pl-k">.</span>showArticle(article<span class="pl-k">.</span>id)<span class="pl-k">.</span>url();
      <span class="pl-k">try</span> {
        <span class="pl-smi">WebSitemapUrl</span> url <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">WebSitemapUrl</span>.<span class="pl-smi">Options</span>(<span class="pl-smi">String</span><span class="pl-k">.</span>format(<span class="pl-s"><span class="pl-pds">"</span>%s%s<span class="pl-pds">"</span></span>, baseUrl, articleUrl))
                                             .changeFreq(<span class="pl-smi">ChangeFreq</span><span class="pl-c1"><span class="pl-k">.</span>DAILY</span>)
                                             .lastMod(article<span class="pl-k">.</span>createdAt)
                                             .priority(<span class="pl-c1">0.5</span>)
                                             .build();
        generator<span class="pl-k">.</span>addUrl(url);
      } <span class="pl-k">catch</span>(<span class="pl-smi">MalformedURLException</span> ex) {
        <span class="pl-smi">play<span class="pl-k">.</span>Logger</span><span class="pl-k">.</span>error(<span class="pl-s"><span class="pl-pds">"</span>The generated url is not supported:  <span class="pl-pds">"</span></span> <span class="pl-k">+</span> articleUrl, ex);
      }
    }
  }

}</pre></div>

<p>Remember that you'll need to add the absolute path of the added URLs.</p>

<p>In order to deliver your sitemaps files, you can use the <code>Sitemaps</code> controller provided by this module. For this, you can simply add the following route to your <code>routes</code> files:</p>

<pre><code>GET     /sitemap$suffix&lt;[^/]*&gt;.xml   com.edulify.modules.sitemap.Sitemaps.sitemap(suffix: String)
</code></pre>

<p>Or you can write your own file deliver. Just remember that the <code>sitemap_index.xml</code>, when generated, links to sitemap#.xml on the defined <em>baseUrl</em>, i.e., the <code>sitemap_index.xml</code> will like look this:</p>

<div class="highlight highlight-text-xml"><pre>&lt;?<span class="pl-ent">xml</span><span class="pl-e"> version</span>=<span class="pl-s"><span class="pl-pds">"</span>1.0<span class="pl-pds">"</span></span><span class="pl-e"> encoding</span>=<span class="pl-s"><span class="pl-pds">"</span>UTF-8<span class="pl-pds">"</span></span>?&gt;

&lt;<span class="pl-ent">sitemapindex</span> <span class="pl-e">xmlns</span>=<span class="pl-s"><span class="pl-pds">"</span>http://www.sitemaps.org/schemas/sitemap/0.9<span class="pl-pds">"</span></span>&gt;

    &lt;<span class="pl-ent">sitemap</span>&gt;
      &lt;<span class="pl-ent">loc</span>&gt;http://www.example.com/sitemap1.xml&lt;/<span class="pl-ent">loc</span>&gt;
    &lt;/<span class="pl-ent">sitemap</span>&gt;

    &lt;<span class="pl-ent">sitemap</span>&gt;
      &lt;<span class="pl-ent">loc</span>&gt;http://www.example.com/sitemap2.xml&lt;/<span class="pl-ent">loc</span>&gt;
    &lt;/<span class="pl-ent">sitemap</span>&gt;

&lt;/<span class="pl-ent">sitemapindex</span>&gt;</pre></div>

<p>for a <code>baseUrl = http://www.example.com</code>.</p>

<h2>
<a id="entry-point" class="anchor" href="#entry-point" aria-hidden="true"><span class="octicon octicon-link"></span></a>Entry point</h2>

<p>Some search engines provide an interface to add the site's sitemap. If your site has no providers or you don't expect that the number of links reaches 50.000 (maximum number of links in each sitemap file), you can point such engines to your <code>sitemap.xml</code>. Otherwise, you must point to <code>sitemap_index.xml</code>, that will have the links the generated sitemaps.</p>

<p>If you are using the <code>Sitemaps</code> controller from the module, you can always use the <code>sitemap_index.xml</code> as the entry point for the search engines; when no <code>sitemap_index.xml</code> is found, the <code>sitemap.xml</code> is automatically delivered.</p>

<h2>
<a id="jpa-gotchas" class="anchor" href="#jpa-gotchas" aria-hidden="true"><span class="octicon octicon-link"></span></a>JPA Gotchas</h2>

<p>Since Play only binds EntityManager when handling requests, you will get errors if you just try to use EntityManager directly inside the <code>UrlProvider</code>. In fact, even if you try <code>@Transactional</code> annotation, which is tightly coupled with <a href="http://www.playframework.com/documentation/2.4.x/JavaActionsComposition">play actions composition</a>, you will get a error complaining that there is no EntityManager bounded to the thread.</p>

<p>Whe using JPA, the correct way to query database outside of action thread is "<em>wrapping the call in <code>JPA.withTransaction</code></em>":</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Override</span>
<span class="pl-k">public</span> <span class="pl-k">void</span> addUrlsTo(<span class="pl-smi">WebSitemapGenerator</span> generator) {

    <span class="pl-smi">String</span> baseUrl <span class="pl-k">=</span> sitemapConfig<span class="pl-k">.</span>getBaseUrl();

    <span class="pl-k">for</span> (<span class="pl-smi">Article</span> article <span class="pl-k">:</span> listArticles()) {
        <span class="pl-smi">String</span> articleUrl <span class="pl-k">=</span> <span class="pl-smi">routes<span class="pl-k">.</span>Application</span><span class="pl-k">.</span>showArticle(article<span class="pl-k">.</span>id)<span class="pl-k">.</span>url();

        <span class="pl-k">try</span> {
            <span class="pl-smi">WebSitemapUrl</span> url <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">WebSitemapUrl</span>.<span class="pl-smi">Options</span>(<span class="pl-smi">String</span><span class="pl-k">.</span>format(
                    <span class="pl-s"><span class="pl-pds">"</span>%s%s<span class="pl-pds">"</span></span>, baseUrl, articleUrl))
                    .changeFreq(<span class="pl-smi">ChangeFreq</span><span class="pl-c1"><span class="pl-k">.</span>DAILY</span>)
                    .priority(<span class="pl-c1">0.5</span>)<span class="pl-k">.</span>build();
            generator<span class="pl-k">.</span>addUrl(url);
        } <span class="pl-k">catch</span> (<span class="pl-smi">MalformedURLException</span> ex) {
            <span class="pl-smi">play<span class="pl-k">.</span>Logger</span><span class="pl-k">.</span>error(<span class="pl-s"><span class="pl-pds">"</span>Invalid URL: <span class="pl-pds">"</span></span> <span class="pl-k">+</span> articleUrl, ex);
        }
    }
}

<span class="pl-k">private</span> <span class="pl-k">List&lt;<span class="pl-smi">Article</span>&gt;</span> listArticles() {
    <span class="pl-k">return</span> <span class="pl-c1">JPA</span><span class="pl-k">.</span>withTransaction(<span class="pl-k">new</span> <span class="pl-smi">F</span>.<span class="pl-k">Function0&lt;<span class="pl-k">List&lt;<span class="pl-smi">Article</span>&gt;</span>&gt;</span>() {
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">List&lt;<span class="pl-smi">Article</span>&gt;</span> <span class="pl-en">apply</span>() <span class="pl-k">throws</span> <span class="pl-smi">Throwable</span> {
            <span class="pl-smi">EntityManager</span> em <span class="pl-k">=</span> <span class="pl-c1">JPA</span><span class="pl-k">.</span>em();
            <span class="pl-k">TypedQuery&lt;<span class="pl-smi">Article</span>&gt;</span> query <span class="pl-k">=</span> em<span class="pl-k">.</span>createNamedQuery(<span class="pl-smi">Article</span><span class="pl-c1"><span class="pl-k">.</span>FIND_ALL</span>, <span class="pl-smi">Article</span><span class="pl-k">.</span>class);
            <span class="pl-k">return</span> query<span class="pl-k">.</span>getResultList();
        }
    });
}</pre></div>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>Copyright 2014 Edulify.com</p>

<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/edulify/play-sitemap-module.edulify.com">Sitemap Generator Module</a> is maintained by <a href="https://github.com/edulify">edulify</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>

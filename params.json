{"name":"Sitemap Generator Module","tagline":"Play module to create automatic sitemaps","body":"# Sitemap Generator Module\r\n\r\nThis is a [sitemap](http://www.sitemaps.org/) module generator for [Play Framework](http://www.playframework.org/) 2.2.2 (for Play 2.1 compatibility, use the module version 1.1.3). It uses [SitemapGen4j](https://code.google.com/p/sitemapgen4j/) to generate the sitemap files.\r\n\r\n## About Sitemaps and SEO\r\n\r\nYou can find more about sitemap and how it matters for Search Engine Optimization at [Tech Talk blog](http://techtalk.edulify.com/2013/04/09/seo-and-sitemap).\r\n\r\n## How it works\r\n\r\n### Configuring\r\n\r\nThe first step is include the sitemapper in your dependencies list, in `Build.scala` file:\r\n\r\n```scala\r\nimport sbt._\r\nimport Keys._\r\nimport play.Project._\r\n\r\nobject ApplicationBuild extends Build {\r\n\r\n  val appName         = \"sitemapper-sample\"\r\n  val appVersion      = \"1.0-SNAPSHOT\"\r\n\r\n  val appDependencies = Seq(\r\n    // Add your project dependencies here,\r\n    javaCore,\r\n    javaJdbc,\r\n    javaEbean,\r\n    \"com.edulify\" % \"sitemapper_2.10\" % \"1.1.5\"\r\n  )\r\n\r\n  val main = play.Project(appName, appVersion, appDependencies).settings(\r\n    // Add your own project settings here\r\n    resolvers += Resolver.url(\"Edulify Repository\", url(\"http://edulify.github.io/modules/releases/\"))(Resolver.ivyStylePatterns)\r\n  )\r\n\r\n}\r\n\r\n```\r\n\r\nDon't forget to add the resolver to your list of resolvers, or it won't work!\r\n\r\nOk, now you need to configure the module in your `application.conf` (the configuration syntax is defined by [Typesafe Config](https://github.com/typesafehub/config)):\r\n\r\n```\r\nsitemap.baseUrl   = \"http://example.com\"\r\nsitemap.baseDir   = \"/complete/path/to/directory/where/sitemap/files/will/be/saved\"\r\nsitemap.providers = sitemap.providers.ArticlesUrlProvider,sitemap.providers.AuthorsUrlProvider\r\n```\r\n\r\n- baseUrl: the base URL for links provided in your sitemap.\r\n- baseDir: as it says, the complete path to directory where you want your sitemap xml files be saved. If you don't provide this value, the sitemap files will be saved under your `public` directory.\r\n- providers: a comma separated list of *provider classes* that will generate URLs for your sitemap (see below).\r\n\r\nYou must also configure an execution context that will execute the sitemap job:\r\n\r\n```\r\nsitemap.dispatcher.name = \"sitemap-generator\"\r\nakka {\r\n\r\n  // see play's thread pools configuration for more details\r\n\r\n  actor {\r\n\r\n    sitemap-generator = {\r\n      fork-join-executor {\r\n        parallelism-factor = 2.0\r\n        parallelism-max = 24\r\n      }\r\n    }\r\n\r\n  }\r\n}\r\n```\r\n\r\n- dispatcher.name: name of the dispatcher used in the Akka system.\r\n\r\nSince the Sitemap Generator runs as a job, you must start `com.edulify.modules.sitemap.SitemapJob` in your Global class. We provide an helper method that uses the execution context configured above. Here is an example:\r\n\r\n```java\r\nimport play.GlobalSettings;\r\nimport com.edulify.modules.sitemap.SitemapJob;\r\n\r\npublic class Global extends GlobalSettings {\r\n\r\n  @Override\r\n  public void onStart(Application app) {\r\n    SitemapJob.startSitemapGenerator();\r\n  }\r\n}\r\n```\r\n\r\n### Using\r\n\r\nWith everything configured, now its time to add some URLs to your sitemap(s). The simplest way is add the `@SitemapItem` annotation to your controllers methods which doesn't expect arguments:\r\n\r\n```java\r\npackage controllers;\r\n\r\nimport com.edulify.modules.sitemap.SitemapItem;\r\nimport com.redfin.sitemapgenerator.ChangeFreq;\r\n\r\npublic class Articles extends Controller {\r\n\r\n  @SitemapItem\r\n  public Result listArticles() { ... }\r\n\r\n  @SitemapItem(changefreq = ChangeFreq.MONTHLY, priority = 0.8)\r\n  public Result specialArticles() { ... }\r\n}\r\n```\r\n\r\nThis will add the route for such method in the sitemap. The default values for the *changefreq* and *priority* attributes are **daily** and **0.5** repectevely.\r\n\r\nFor methods that needs arguments, you must implement a URL provider that will add the generated URL to sitemap. Here is an example:\r\n\r\n```java\r\npackage sitemap.providers;\r\n\r\nimport java.net.MalformedURLException;\r\nimport java.util.List;\r\n\r\nimport models.Article;\r\n\r\nimport controllers.routes;\r\nimport play.Play;\r\n\r\nimport com.edulify.modules.sitemap.UrlProvider;\r\n\r\nimport com.redfin.sitemapgenerator.ChangeFreq;\r\nimport com.redfin.sitemapgenerator.WebSitemapUrl;\r\nimport com.redfin.sitemapgenerator.WebSitemapGenerator;\r\n\r\npublic class ArticlesUrlProvider implements UrlProvider {\r\n\r\n  @Override\r\n  public void addUrlsTo(WebSitemapGenerator generator) {\r\n    String baseUrl = Play.application().configuration().getString(\"sitemap.baseUrl\");\r\n\r\n    List<Article> articles = Article.find.all();\r\n    for(Article article : articles) {\r\n      String articleUrl = routes.Application.showArticle(article.id).url();\r\n      try {\r\n        WebSitemapUrl url = new WebSitemapUrl.Options(String.format(\"%s%s\", baseUrl, articleUrl))\r\n                                             .changeFreq(ChangeFreq.DAILY)\r\n                                             .lastMod(article.createdAt)\r\n                                             .priority(0.5)\r\n                                             .build();\r\n        generator.addUrl(url);\r\n      } catch(MalformedURLException ex) {\r\n        play.Logger.error(\"wat? \" + articleUrl, ex);\r\n      }\r\n    }\r\n  }\r\n\r\n}\r\n```\r\n\r\nRemember that you'll need to add the absolute path of the added URLs.\r\n\r\nIn order to deliver your sitemaps files, you can use the `SitemapController` provided by this module. For this, you can simply add the following route to your `routes` files:\r\n\r\n<pre>\r\nGET     /sitemap$suffix<[^/]*>.xml   com.edulify.modules.sitemap.SitemapController.sitemap(suffix: String)\r\n</pre>\r\n\r\nOr you can write your own file deliver. Just remember that the `sitemap_index.xml`, when generated, links to sitemap#.xml on the defined *baseUrl*, i.e., the `sitemap_index.xml` will like look this:\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n\r\n<sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\r\n\r\n    <sitemap>\r\n      <loc>http://www.example.com/sitemap1.xml</loc>\r\n    </sitemap>\r\n\r\n    <sitemap>\r\n      <loc>http://www.example.com/sitemap2.xml</loc>\r\n    </sitemap>\r\n\r\n</sitemapindex>\r\n```\r\n\r\nfor a `baseUrl = http://www.example.com`.\r\n\r\n### Entry point\r\n\r\nSome search engines provide an interface to add the site's sitemap. If your site has no providers or you don't expect that the number of links reaches 50.000 (maximum number of links in each sitemap file), you can point such engines to your `sitemap.xml`. Otherwise, you must point to `sitemap_index.xml`, that will have the links the generated sitemaps.\r\n\r\nIf you are using the `SitemapController` from the module, you can always use the `sitemap_index.xml` as the entry point for the search engines; when no sitemap_index is found, the `sitemap.xml` is automatically delivered.\r\n\r\n## JPA Gotchas\r\n\r\nSince Play just bound EntityManager in threads handling actions, you will get errors if you just try to use EntityManager directly inside the `UrlProvider`. In fact, even if you try `@Transactional` annotation, which is tightly coupled with [play actions composition](http://www.playframework.com/documentation/2.2.x/JavaActionsComposition), you will get a error complaining that there is no EntityManager bound to the thread.\r\n\r\nWhe using JPA, the correct way to query database outside of action thread is \"*wrapping the call in `JPA.withTransaction`*\":\r\n\r\n```java\r\n@Override\r\npublic void addUrlsTo(WebSitemapGenerator generator) {\r\n\r\n    String baseUrl = Play.application().configuration().getString(\"sitemap.baseUrl\");\r\n\r\n    for (Article article : listArticles()) {\r\n        String articleUrl = routes.Application.showArticle(article.id).url();\r\n\r\n        try {\r\n            WebSitemapUrl url = new WebSitemapUrl.Options(String.format(\r\n                    \"%s%s\", baseUrl, articleUrl))\r\n                    .changeFreq(ChangeFreq.DAILY)\r\n                    .priority(0.5).build();\r\n            generator.addUrl(url);\r\n        } catch (MalformedURLException ex) {\r\n            play.Logger.error(\"wat? \" + articleUrl, ex);\r\n        }\r\n    }\r\n}\r\n\r\nprivate List<Article> listArticles() {\r\n    return JPA.withTransaction(new F.Function0<List<Article>>() {\r\n        @Override\r\n        public List<Article> apply() throws Throwable {\r\n            EntityManager em = JPA.em();\r\n            TypedQuery<Article> query = em.createNamedQuery(Article.FIND_ALL, Article.class);\r\n            return query.getResultList();\r\n        }\r\n    });\r\n}\r\n```","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}